<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Schema.org Editor</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
   <div class="container">
    <h1>Schema.org Editor</h1>
    <form>
     <div class="row">
      <div class="col-md-4">
       <div class="form-group">
        <select class="form-control"
               data-bind="options: availableTypes, 
                         optionsText: 'name',
                         optionsValue: 'value',
                         value: selectedType">
        </select>
       </div>
      </div>
      <div class=col-md-4">
         <div class="btn-group"> 
          <button data-bind="click: clearForm" class="btn btn-default">
           Clear
          </button>
          <button data-bind="click: showTypeEditor"
                  class="btn btn-default">New</button>
          <button data-bind="click: editEntityTypeEditor" 
                   class="btn btn-default">
           Edit          
          </button>
         </div>
      </div>
     </div>
    </form>
    {# START Search form row #}
    <div class="row">
     {# START Search column #}
      <div class="col-md-6 col-md-offset-2">
      {# START Search panel #}
      <div data-bind="visible: showSearch" 
           class="panel-primary panel">
       {# START Search panel-heading #}
       <div class="panel-heading"> 
        Search 
        <button type="button" class="close" data-bind="click: closeSearch"><span aria-hidden="true">&times;</span>
       {# END Search panel-heading #}
       </div>
       {# START Search panel-body #}
       <div class="panel-body">
        <form class="form-inline" role="form">
         {# START Search form-group #}
         <div class="form-group">
          <input type="text" 
                 data-bind="value: idSearchValue"
                 class="form-control" id="idSearch" 
                 placeholder="Identifier String">
          <button type="submit" class="btn btn-default">Retrieve</button>
        {# END Search form-group #}
        </div>
       </form>
       {# END Search panel-body #}
       </div>
      {# END Search panel #}
      </div>
     {# END Search column #}
     </div>
   {# END Search form row #}
   </div>

    <div data-bind="visible: editorPane" class="pane container">
      <h2 data-bind="text: editingType"></h2>
      <input type="hidden" id="entity_id" data-bind="value: idValue">
      <!-- ko foreach: typeProperties -->
      <div class="form-group">
        <label data-bind="text: propName, 
                          attr: { for: propId }"></label>
        
        <input type="text" 
               class="form-control"
               onblur="updateValue(this)"
               data-bind="attr: { id: propId,
                                  placeHolder: propComment,
                                  type: propType },
                          value: propValue"
                          ></input>
      </div>
      <!-- /ko -->
    </div>
   </div>


   <div class="row container">
     <div class="col-md-12">
      All original Source code under the 
      <a href="http://opensource.org/licenses/MIT">MIT</a> open-source license.
      Github source code repository at 
      <a href="https://github.com/jermnelson/schema-org-editor">https://github.com/jermnelson/schema-org-editor</a>.
      Please <a href="mailto:jeremy.nelson@coloradocollege.edu">email</a> Jeremy Nelson with any questions and use 
      Github's <a href="https://github.com/jermnelson/schema-org-editor/issues">issues</a> to report bugs, questions,
      and enhancement requests.
     </div>
   </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
<script>

{#  ko.bindingHandler.updateProperty = {
    init: function(element, valueAccessor) {


    }


  }#}
 
  function updateValue(element) {
    if(element.value.length > 0) { 
      var entity_id = $('#entity_id').val();
      $.ajax({
        type: 'POST',
        url: '/update',
        data: { name: element.id,
                entityid: entity_id,
                value: element.value }
      }).done(function(status) {
        if(!status) {
          alert(element.id + " not saved for " + entity_id);
        }
      });
    }
  }
 
  function EntityProperty(propId, 
                          propName, 
                          propComment, 
                          propType,
                          propValue) {
     self = this;
     self.propId = propId;
     self.propName = propName;
     self.propComment = propComment;
     self.propType = propType;
     self.propValue = ko.observable(propValue);
     self.propValue.focused = ko.observable();
     self.propValue.focused.subscribe(function(isActive) {
      if(!isActive) {
        if(self.propValue().length < 1) {
         console.log("Prop value is " + self.propValue);
        } else { console.log("Should now do something with value") }
      }
     });
  }
 
  function viewModel(schema) {
    var self = this;
    self.schema = schema;
    self.availableTypes = ko.observableArray();
    self.clearForm = function() {
      self.typeProperties.removeAll();
      self.editingType("");
    }
    self.closeSearch = function() {
      self.showSearch(false);
    }
    self.editorPane = ko.observable(false);
    self.idSearchValue = ko.observable();
    self.selectedType = ko.observable();
    self.editingType = ko.observable();
    self.editEntityTypeEditor = function() {
      self.clearForm();
      self.showSearch(true);
    }
    
    self.typeProperties = ko.observableArray();
    self.showSearch = ko.observable(false);

    for(name in self.schema['types']) {
      var type = schema['types'][name];
      self.availableTypes.push({'value':name, 'name': type.label});
    }
    self.showTypeEditor = function() { 
      self.showSearch(false);
      if(self.idValue().length < 1) {
        var new_url = '/id/new/' + self.selectedType();
        console.log(new_url);
         $.ajax({url: new_url,
                 schema_type: self.selectedType()}).done(function(data) {
             self.idValue(data);
         });
      }
      self.typeProperties.removeAll();
      var type = schema['types'][self.selectedType()];
      self.editingType(type.label);
      var propertyFields = ['properties', 'specific_properties'];
      for(i in propertyFields) {
       var propertyField = propertyFields[i];
       for(j in type[propertyField]) {
         var propId = type[propertyField][j]
         var propName = schema['properties'][propId]['label'];
         var propComment = schema['properties'][propId]['comment_plain'];
         var inputType = 'text';
         if($.inArray('Date', schema['properties'][propId]['ranges']) > -1) {
           inputType = 'date';
         }
         self.typeProperties.push(new EntityProperty(
                                                     propId,
                                                     propName,
                                                     propComment,
                                                     inputType,
                                                     ''));
                                   
       }
      }
      self.typeProperties.sort(
        function(left, right) {
          if(left.propId > right.propId) { return 1; } else { return -1; }
       }); 
      
      self.editorPane(true);
    }
  
   self.updateValue = function(property) {
     console.log("Propetery " + property.propName + " value " + property.propValue());
   }
   self.idValue = ko.observable("");
  }
 $.getJSON('http://schema.rdfs.org/all.json', function(data) {
    ko.applyBindings(new viewModel(data));
 });

  
</script>
  </body>
</html>
